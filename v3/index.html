<html>
  <head>
    <link rel="stylesheet" href="style.css">
    <script src='https://cdn.jsdelivr.net/npm/luxon@1.25.0/build/global/luxon.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/chart.js@2.9.3'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/regression/2.0.1/regression.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@0.2.1'></script>
    <script src='js/bayou.js'></script>

  </head>
<body>

<input type="file" id="fileinput" />


<canvas id="overlay" width="300" height="50" style="position:absolute;pointer-events:none;"></canvas>

<canvas id="myChart" width="300" height="50"></canvas>

<p id="fitval"><b>ACH</b>:</p>

<canvas id="exponential" width="300" height="50"></canvas>

<p id="linear"><b>slope</b>; <b>intercept</b>; <b>R2</b></p>

<canvas id="myFit" width="300" height="50"></canvas>


<script>
  var c = document.getElementById('myChart')
      c.width  = 200;
      c.height = 50;
      var d = document.getElementById('overlay')
      c.width  = 200;
      c.height = 50;
      var e = document.getElementById('exponential')
      c.width  = 200;
      c.height = 50;
      var f = document.getElementById('myFit')
      c.width  = 200;
      c.height = 50;

</script>



<script>
  function csvJSON(csv){

var lines=csv.split("\n");

var result = [];

// NOTE: If your columns contain commas in their values, you'll need
// to deal with those before doing the next step 
// (you might convert them to &&& or something, then covert them back later)
// jsfiddle showing the issue https://jsfiddle.net/
//var headers=lines[0].split(",");
var headers =["Time","CO2","Temp","Humid","Press"];
for(var i=1;i<lines.length-1;i++){

    var obj = {};
    var currentline=lines[i].split(",");

    for(var j=0;j<headers.length;j++){
        obj[headers[j]] = currentline[j];
    }

    result.push(obj);

}
//console.log(result);

return result; //JavaScript object
//return JSON.stringify(result); //JSON

}
</script>

<script>
  function readSingleFile(evt) {
    var f = evt.target.files[0]; 
    if (f) {


      var r = new FileReader();
      
      r.onload = function(e) { 
          var contents = e.target.result;
          //document.write("File Uploaded! <br />" + "name: " + f.name + "<br />" + "content: " + contents + "<br />" + "type: " + f.type + "<br />" + "size: " + f.size + " bytes <br />");

          // try the parser:
          var p = csvJSON(contents);
          //console.log(p);
          var in_json = csvJSON(contents);

          var feed_pubkey = "2323";
          var plot_param = "co2";
          var limit = 100;
          var node_id=0;
          var co2_ambient = 412;

          var co2_vs_time = [];

          for (var i =0; i<p.length;i++) {
            var thisItem = p[i];
            var co2StrDouble = thisItem['CO2'];
            var timeutc = thisItem['Time'];
            var co2Str = co2StrDouble.replace(/['"]+/g, '');
              //console.log(parseInt(co2Str));
              var co2 = parseInt(co2Str);

              var luxtime = luxon.DateTime.fromFormat(timeutc, "M/d/yyyy h:mm:ss a");

              //console.log(luxtime.toString());
  
              co2_vs_time.push({"t":luxtime,"y":co2})
            }

          makeNodeChart('myChart',co2_vs_time,co2_ambient);

     }
      r.readAsText(f);
      //document.write(output);
    } else { 
      alert("Failed to load file");
    }
  }
  document.getElementById('fileinput').addEventListener('change', readSingleFile);
</script>
</body>
</html>